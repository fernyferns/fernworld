<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex">
    <title>Fernworld</title>
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chilanka&display=swap" rel="stylesheet">
    <style>
        html {
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            margin-left: 2em;
            margin-right: 2em;
            max-width: 800px;
        }

        * {
            font-family: 'Chilanka';
        }

        p {
            margin-bottom: 1.3em;
        }

        .alert {
            background-color: lemonchiffon;
        }
    </style>
    <script src="./sjcl.js"></script>
</head>

<script>

    var alertShown = false;

    function login(manualLogin = false) {

        var password = "";

        try {

            if (manualLogin) {
                password = document.getElementById("password").value || "";
                localStorage.setItem("password", password);
                decryptAndRender(password);
                return;
            }

            else {

                //check if password is in query string
                password = getParameterByName("password");
                if (password) {
                    localStorage.setItem("password", password);
                    decryptAndRender(password);
                    return;
                }

                //check if password is already in storage
                password = localStorage.getItem("password");
                if (password) {
                    decryptAndRender(password);
                    return;
                }

            }

        } catch (error) {
            //clear session storage on error.
            localStorage.removeItem("password");
            if (error) {
                if (error.message == "ccm: tag doesn't match") {
                    showAlert("Password incorrect");
                } else if (error.message) {
                    showAlert(error.message);
                } else {
                    showAlert("Something went wrong.");
                }
            }
        }

    }

    function decryptAndRender(password) {
        var decryptedHtmlPage = sjcl.decrypt(password, encryptedHtml);
        document.open("text/html", "replace");
        document.write(decryptedHtmlPage);
        document.close();
    }

    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function showAlert(message) {
        var container = document.getElementById("alert");
        if (container) {
            container.outerHTML = `<p id="alert" class="alert" onClick="dismissAlert()"><a href="#" onClick="dismissAlert()">[x]</a>&nbsp;&nbsp;${message}</p>`;
            alertShown = true;
        }
    }

    function dismissAlert() {
        var container = document.getElementById("alert");
        if (container) {
            container.outerHTML = `<p id="alert"></p>`;
            alertShown = false;
        }
    }

    function passwordKeyPress(event) {
        if (alertShown) {
            dismissAlert();
        }
        if (event.key == "Enter") {
            login(true);
        }
    }

    var encryptedHtml = '{"iv":"DCLCLxO6VG3B7e4VOlRZdA==","v":1,"iter":10000,"ks":128,"ts":64,"mode":"ccm","adata":"","cipher":"aes","salt":"q/JLYWZTrII=","ct":"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"}';

    login();


</script>

<body onload="onLoad()">

    <noscript>
        <p class="alert">This site requires JavaScript to function. Login will not function without scripts enabled.</p>
    </noscript>

    <p id="alert"></p>

    <h1>
        Login
    </h1>

    <div>
        <label for="password">Password</label>
        <input type="password" id="password" required disabled onkeypress="passwordKeyPress(event)" />
        <p>Ask Fern if you don't know the password.</p>
    </div>

    <p>
        <button disabled type="button" id="loginBtn" onclick="login(true)">
            Login
        </button>
    </p>

    <script>

        function onLoad() {

            //enable login button.
            document.getElementById("loginBtn").removeAttribute("disabled");
            document.getElementById("password").removeAttribute("disabled");

            login();

        }

    </script>

</body>

</html>