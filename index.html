<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex">
    <title>Fernworld</title>
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chilanka&display=swap" rel="stylesheet">
    <style>
        html {
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            margin-left: 2em;
            margin-right: 2em;
            max-width: 800px;
        }

        * {
            font-family: 'Chilanka';
        }

        p {
            margin-bottom: 1.3em;
        }

        .alert {
            background-color: lemonchiffon;
        }
    </style>
    <script src="./sjcl.js"></script>
</head>

<script>

    var alertShown = false;

    function login(manualLogin = false) {

        var password = "";

        try {

            if (manualLogin) {
                password = document.getElementById("password").value || "";
                localStorage.setItem("password", password);
                decryptAndRender(password);
                return;
            }

            else {

                //check if password is in query string
                password = getParameterByName("password");
                if (password) {
                    localStorage.setItem("password", password);
                    decryptAndRender(password);
                    return;
                }

                //check if password is already in storage
                password = localStorage.getItem("password");
                if (password) {
                    decryptAndRender(password);
                    return;
                }

            }

        } catch (error) {
            //clear session storage on error.
            localStorage.removeItem("password");
            if (error) {
                if (error.message == "ccm: tag doesn't match") {
                    showAlert("Password incorrect");
                } else if (error.message) {
                    showAlert(error.message);
                } else {
                    showAlert("Something went wrong.");
                }
            }
        }

    }

    function decryptAndRender(password) {
        var decryptedHtmlPage = sjcl.decrypt(password, encryptedHtml);
        document.open("text/html", "replace");
        document.write(decryptedHtmlPage);
        document.close();
    }

    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function showAlert(message) {
        var container = document.getElementById("alert");
        if (container) {
            container.outerHTML = `<p id="alert" class="alert" onClick="dismissAlert()"><a href="#" onClick="dismissAlert()">[x]</a>&nbsp;&nbsp;${message}</p>`;
            alertShown = true;
        }
    }

    function dismissAlert() {
        var container = document.getElementById("alert");
        if (container) {
            container.outerHTML = `<p id="alert"></p>`;
            alertShown = false;
        }
    }

    function passwordKeyPress(event) {
        if (alertShown) {
            dismissAlert();
        }
        if (event.key == "Enter") {
            login(true);
        }
    }

    var encryptedHtml = '{"iv":"3jZQt5WHG8jyhyZxVaBN5A==","v":1,"iter":10000,"ks":128,"ts":64,"mode":"ccm","adata":"","cipher":"aes","salt":"q/JLYWZTrII=","ct":"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"}';

    login();


</script>

<body onload="onLoad()">

    <noscript>
        <p class="alert">This site requires JavaScript to function. Login will not function without scripts enabled.</p>
    </noscript>

    <p id="alert"></p>

    <h1>
        Login
    </h1>

    <div>
        <label for="password">Password</label>
        <input type="password" id="password" required disabled onkeypress="passwordKeyPress(event)" />
        <p>Ask Fern if you don't know the password.</p>
    </div>

    <p>
        <button disabled type="button" id="loginBtn" onclick="login(true)">
            Login
        </button>
    </p>

    <script>

        function onLoad() {

            //enable login button.
            document.getElementById("loginBtn").removeAttribute("disabled");
            document.getElementById("password").removeAttribute("disabled");

            login();

        }

    </script>

</body>

</html>