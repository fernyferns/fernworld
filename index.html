<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex">
    <title>Fernworld</title>
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chilanka&display=swap" rel="stylesheet">
    <style>
        html {
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            margin-left: 2em;
            margin-right: 2em;
            max-width: 800px;
        }

        * {
            font-family: 'Chilanka';
        }

        p {
            margin-bottom: 1.3em;
        }

        .alert {
            background-color: lemonchiffon;
        }
    </style>
    <script src="./sjcl.js"></script>
</head>

<script>

    var alertShown = false;

    function login(manualLogin = false) {

        var password = "";

        try {

            if (manualLogin) {
                password = document.getElementById("password").value || "";
                localStorage.setItem("password", password);
                decryptAndRender(password);
                return;
            }

            else {

                //check if password is in query string
                password = getParameterByName("password");
                if (password) {
                    localStorage.setItem("password", password);
                    decryptAndRender(password);
                    return;
                }

                //check if password is already in storage
                password = localStorage.getItem("password");
                if (password) {
                    decryptAndRender(password);
                    return;
                }

            }

        } catch (error) {
            //clear session storage on error.
            localStorage.removeItem("password");
            if (error) {
                if (error.message == "ccm: tag doesn't match") {
                    showAlert("Password incorrect");
                } else if (error.message) {
                    showAlert(error.message);
                } else {
                    showAlert("Something went wrong.");
                }
            }
        }

    }

    function decryptAndRender(password) {
        var decryptedHtmlPage = sjcl.decrypt(password, encryptedHtml);
        document.open("text/html", "replace");
        document.write(decryptedHtmlPage);
        document.close();
    }

    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function showAlert(message) {
        var container = document.getElementById("alert");
        if (container) {
            container.outerHTML = `<p id="alert" class="alert" onClick="dismissAlert()"><a href="#" onClick="dismissAlert()">[x]</a>&nbsp;&nbsp;${message}</p>`;
            alertShown = true;
        }
    }

    function dismissAlert() {
        var container = document.getElementById("alert");
        if (container) {
            container.outerHTML = `<p id="alert"></p>`;
            alertShown = false;
        }
    }

    function passwordKeyPress(event) {
        if (alertShown) {
            dismissAlert();
        }
        if (event.key == "Enter") {
            login(true);
        }
    }

    var encryptedHtml = '{"iv":"xjHKCybT5c+bu6Daa5lMfw==","v":1,"iter":10000,"ks":128,"ts":64,"mode":"ccm","adata":"","cipher":"aes","salt":"Ixabti4G6l0=","ct":"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"}';

    login();


</script>

<body onload="onLoad()">

    <noscript>
        <p class="alert">This site requires JavaScript to function. Login will not function without scripts enabled.</p>
    </noscript>

    <p id="alert"></p>

    <h1>
        Login
    </h1>

    <div>
        <label for="password">Password</label>
        <input type="password" id="password" required disabled onkeypress="passwordKeyPress(event)" />
        <p>Ask Fern if you don't know the password.</p>
    </div>

    <p>
        <button disabled type="button" id="loginBtn" onclick="login(true)">
            Login
        </button>
    </p>

    <script>

        function onLoad() {

            //enable login button.
            document.getElementById("loginBtn").removeAttribute("disabled");
            document.getElementById("password").removeAttribute("disabled");

            login();

        }

    </script>

</body>

</html>